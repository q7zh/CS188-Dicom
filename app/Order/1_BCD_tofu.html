<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
    	<title>Dicom</title>
    	<link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
    	<link href="../../jquery/css/ui-lightness/jquery-ui-1.10.0.custom.css" rel="stylesheet" />
    	<link href="../../css/BCD_tofu.css" rel="stylesheet" />
	</head>
	<body>
		<script src="../../jquery/js/jquery-1.9.0.min.js"></script>
    	<script src="../../jquery/js/jquery-ui-1.10.0.custom.min.js"></script>
		<script src="./javascript/placeOrder.js"></script>
		<script src="./javascript/tipPage.js"></script>

		<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-app.js"></script>
    	<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-firestore.js"></script> 

		<script>

			$(document).ready(function(){

				///////////////////////////////////////////////////////////////////
				//Constants and functions to set up
				const COLLECTIONNAME = "BCD"; //will be "items"
				const ITEMNAME = "tofu";
				const ITEMPRICE = 6;
				let firstTimeSavingItem;

				async function saveToDB(myDb, myDocRef, firstSaveForItem) {
					console.log("Initiating save to Firestore...");
					console.log($("#selectedQuantityValue").attr("value"));

					//See editItem.js for details on DB scheme
					await myDocRef.set({
						title: ITEMNAME,
						price: ITEMPRICE,
						quantity: $("#selectedQuantityValue").attr("value"),
						note: $("#noteValue").val() //NOT .html(), see http://api.jquery.com/val/
					}).then(function() {
						console.log("Status saved!");
					}).catch(function(error) {
						console.log("Got an error saving to Firestore: ", error);
					});

					if (firstSaveForItem)
					{
						//And now... Let's update our dictionary with this newly created doc's id
				   		//(The collection must already contain this doc in order for update() to work)
				   		await myDb.collection(COLLECTIONNAME).doc("document_dictionary").update({
								[ITEMNAME]: myDocRef.id
							}).then(function() {
								console.log("Document Dictionary updated in Firestore!");
							}).catch(function(error) {
								console.log("Error updating Document Dictionary in Firestore: ", error);
						});
					}
				}

				async function getDocForItem(myDb, myName) {
					let myDocRef;

					//See "get()"--this returns a promise to a DocumentSnapshot object
			        //https://firebase.google.com/docs/reference/js/firebase.firestore.DocumentReference#get
			        //Also:  https://firebase.google.com/docs/reference/js/firebase.firestore.DocumentSnapshot
			        await myDb.collection(COLLECTIONNAME).doc("document_dictionary").get().then(async function(doc) {
				       	if (doc && doc.exists) {
				       		const myData = doc.data();
				       		
				       		if (doc.get(myName) != undefined)
				       		{
				       			console.log("Field exists for", myName, "in document_dictionary");
				       			firstTimeSavingItem = false;
				       			myDocRef = myDb.collection(COLLECTIONNAME).doc(doc.get(myName));
				       		}

				       		//Database doesn't contain doc for this item, so let's make it
				       		else 
				       		{
				       			console.log("Field does NOT exist for", myName, "in document_dictionary");
				       			firstTimeSavingItem = true;
			       				myDocRef = myDb.collection(COLLECTIONNAME).doc();
				       		}
				       		console.log("Printing mydocRef right here");
				       		console.log(myDocRef);
					    }
				       	else
				       	{
				       		console.log("document_dictionary doesn't exist in Firestore. Let's go and make it...");
				       		//db.collection(COLLECTIONNAME).doc("document_dictionary").set(); //Creates the doc
				       	}

			       }).catch(function (error) {
			       	console.log("Error retrieving document_dictionary from Firestore: ", error)
			       });

			       	return myDocRef;
				}


				///////////////////////////////////////////////////////////////////
				//Initialize DB and do a read
				firebase.initializeApp({
            	apiKey: "AIzaSyDmtlSHDnZwX2AF6jl2jx-SJCjyQnUTuts",
            	authDomain: "web-quickstart-f6007.firebaseapp.com",
            	projectId: "web-quickstart-f6007"
        		});

		        // Initialize Cloud Firestore through Firebase
		        var db = firebase.firestore();
		       	// Disable deprecated features
		        db.settings({
		            timestampsInSnapshots: true
		        });

		        //const docRef = db.doc("/test1/lod1CsUXdtSWoHFU0flD")


		        getDocForItem(db, ITEMNAME).then(docRef => {
		        	console.log("Printing from main loop");
					console.log(docRef);

			       // Load from database
			       docRef.get().then(function(doc) {
			       	if (doc && doc.exists) {
			       		const myData = doc.data();
			       		if (myData.quantity == undefined)
			       			$("#selectedQuantityValue").attr("value", "0");
			       			//$("#topListItemText").html("0");
			       		else 
			       			$("#selectedQuantityValue").attr("value", myData.quantity);
			       		$(".miniLoader").css('display', 'none');

			       		if (myData.note != undefined)
			       			$("#noteValue").val(myData.note)
			       	}
			       	else
			       	{
			       		console.log(ITEMNAME, "document in Firestore not found!");
			       		$("#selectedQuantityValue").attr("value", "0");
			       	}
			       }).catch(function (error) {
			       	console.log("Error loading item document from Firestore: ", error)
			       });



			        ///////////////////////////////////////////////////////////////////
			        //Watch for Events
	   				$(".userQuantitySelection").click(function() {
	   					$(".userQuantityOptions").css('display', 'none');
	   					$("#topListItemText").html($(this).html());  
	   				});

	   				$(".userQuantityOptions").mouseleave(function() {
	   					$(this).css('display', ''); //resets display value to "blank"
	   					//https://stackoverflow.com/questions/1053418/jquery-temporarily-change-a-style-then-reset-to-original-class
	   				});

	   				$("#addToCart").click(async function () {
	   					$(".loader").css('display', '');
	   					console.log("Before saveToDB() call");
	   					await saveToDB(db, docRef, firstTimeSavingItem);
	   					console.log("After saveToDB() call");

	   					//Load next page
	   					//Refernece: https://stackoverflow.com/questions/133925/javascript-post-request-like-a-form-submit
	   					var form = $('<form></form>');

					    form.attr("method", "get");
					    form.attr("action", "./0_BCD_restaurantMenu.html");

					    //var parameters = {
					    //	"key1": "value1",
					    //	"key2": "value2"
					    //};

					    //http://api.jquery.com/jquery.each/
					    //$.each(parameters, function(key, value) {
					    //    var field = $('<input></input>');

					    //    field.attr("type", "hidden");
					    //    field.attr("name", key);
					    //    field.attr("value", value);

					    //    form.append(field);
					    //	});

					    // The form needs to be a part of the document in
					    // order for us to be able to submit it.
					    $(document.body).append(form);
					    form.submit();
					})

		        }); //end getDocForItem promise resolve		        

			});
		</script>


		<div class="header">
			<div class="backButton">
				<a href="0_BCD_restaurantMenu.html"><i class="fas fa-chevron-left"></i></a>
			</div>
			Restaurant Menu	
		</div>

		<div class="background">
			<div class="restaurantImage">
				<div class="bottomLeft"></div>
				<img src="../../images/galbiTofuCropped.jpg" height="164" width="376">
			</div>

			<div class="menuItemHeader">
				<div class="menuItemName">Tofu with Kalbi Combo</div>
				<div class="menuItemDescription">
				Lightly browned tofu with Korean BBQ short sliced rib.
				</div>
			</div> <!-- End menuHeader -->

			<div class="quantityDiv">
				<div class="menuCategory" style="height:175px;">
					<div class="quantitySelectionText">Please select quantity:</div>
					<div class="quantitySelectionLine">
					<!-- <div id="flex_max_container"> -->
						<div class="quantityPlusMinus" style="width: 150px">
							<button class="plus-btn" type="button" name="button">+</button>
							<input type="text" name="name" id="selectedQuantityValue" value="">
							<button class="minus-btn" type="button" name="button">-</button>
						</div>
						<!-- <div class="quantityDropdown">
							<nav id="quantity_dropdown_wrap">
								<ul>
								  <li><a id="topListItem" href="#"><span id="topListItemText"></span>&nbsp&nbsp<i class="fas fa-caret-down"></i></a>
								    <ul class="userQuantityOptions">
								      <li><a class="userQuantitySelection" href="#">0</a></li>
								      <li><a class="userQuantitySelection" href="#">1</a></li>
								      <li><a class="userQuantitySelection" href="#">2</a></li>
								      <li><a class="userQuantitySelection" href="#">3</a></li>
								      <li><a class="userQuantitySelection" href="#">4</a></li>
								      <li><a class="userQuantitySelection" href="#">5</a></li>
									</ul>
								  </li>
								</ul>
							</nav>
						</div>	--> <!-- end quantityDropdown -->
	
						<div class="quantityAmount" style="width: 75px">Combo</div>
						<div class="quantityPrice" style="width: 75px">$6</div>
						<!-- <div class="item-number">Item-Number</div>			 -->
					<!-- </div>	end flex_max_container -->
				</div>  <!-- end quantitySelection -->

				<div class="Notes">
					<textarea rows="9" id="noteValue" placeholder="Please leave any additional notes here"></textarea>
				</div>
			</div>  <!-- end menuCategory -->

			<div class="addToCartContainer">
				<!-- <a href="./0_BCD_restaurantMenu.html"> -->
				<button type="button" id="addToCart">Add to Cart</button>
				<!-- </a> -->
			</div>

			<div class="loader" style="display: none"></div>
			<div class="miniLoader" style="display: inline"></div>
			<!--<input type="text" placeholder='Add a Note (extra services…)'>-->
<!-- 
			<div id="flex_max_container">
			  <div>
			  	<p>1</p>
			  </div>

			  <div>
			  	<p>2</p>
			  </div>

			  <div>
			  	<p>3</p>
			  </div>
			</div>
 -->


		</div>	<!-- end background -->	
		
    	<script>
    	//Copied and pasted from utensils.js, with a few changes...
    		$('.minus-btn').on('click', function(e) {
			    e.preventDefault();
			    var $this = $(this);
			    var $input = $this.closest('div').find('input');
			    var value = parseInt($input.val());
			    if (value > 1) {
			    	value = value - 1;
			    } else {
			    	value = 0;
			    }

			    $input.val(value);
			    $("#selectedQuantityValue").attr("value", value); //save to db doesn't work without this
			});

			$('.plus-btn').on('click', function(e) {
			    e.preventDefault();
			    var $this = $(this);
			    var $input = $this.closest('div').find('input');
			    var value = parseInt($input.val());
			    if (value < 100) {
					value = value + 1;
			    } else {
			    		value =100;
			    }

			    $input.val(value);
			    $("#selectedQuantityValue").attr("value", value); //save to db doesn't work without this
			});


			// function add_click(){
			// 	location.href = "3_servicesConfirmed.html"
			// }
    	</script>
	</body>
</html>